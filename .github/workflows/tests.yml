name: Run Tests

on:
    pull_request:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        environment: ci
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4.1.7

            - name: Create .env from secrets
              if: github.event.pull_request.head.repo.fork == false
              run: |
                  cat <<'EOF' > .env
                  API_NODE_ENV=test
                  API_DATABASE_ENV=test
                  API_PG_DB_USERNAME=${{ secrets.API_PG_DB_USERNAME }}
                  API_PG_DB_PASSWORD=${{ secrets.API_PG_DB_PASSWORD }}
                  API_PG_DB_DATABASE=${{ secrets.API_PG_DB_DATABASE }}
                  API_PG_DB_HOST=${{ secrets.API_PG_DB_HOST }}
                  API_PG_DB_PORT=${{ secrets.API_PG_DB_PORT }}
                  API_MG_DB_USERNAME=${{ secrets.API_MG_DB_USERNAME }}
                  API_MG_DB_PASSWORD=${{ secrets.API_MG_DB_PASSWORD }}
                  API_MG_DB_DATABASE=${{ secrets.API_MG_DB_DATABASE }}
                  API_MG_DB_HOST=${{ secrets.API_MG_DB_HOST }}
                  API_MG_DB_PORT=${{ secrets.API_MG_DB_PORT }}
                  API_CRYPTO_KEY=${{ secrets.API_CRYPTO_KEY }}
                  EOF

            - name: Create .env for forks
              if: github.event.pull_request.head.repo.fork == true
              run: |
                  cat <<'EOF' > .env
                  API_NODE_ENV=test
                  API_DATABASE_ENV=test
                  API_PG_DB_USERNAME=kodusdev
                  API_PG_DB_PASSWORD=123456
                  API_PG_DB_DATABASE=kodus_db
                  API_PG_DB_HOST=db_postgres
                  API_PG_DB_PORT=5432
                  API_MG_DB_USERNAME=kodusdev
                  API_MG_DB_PASSWORD=123456
                  API_MG_DB_DATABASE=kodus_db
                  API_MG_DB_HOST=db_mongodb
                  API_MG_DB_PORT=27017
                  API_CRYPTO_KEY=0000000000000000000000000000000000000000000000000000000000000000
                  EOF

            - name: Create network
              run: docker network create kodus-backend-services-test || true

            - name: Docker Compose Action UP
              uses: hoverkraft-tech/compose-action@v2.0.1
              with:
                  compose-file: ./docker-compose.test.yml
                  up-flags: "-d"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      .yarn/cache
                      **/node_modules
                  key: ${{ runner.os }}-node22-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-node22-yarn-

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Create environment.ts for tests
              run: |
                  cat <<'EOF' > libs/ee/configs/environment/environment.ts
                  import { environment as devEnvironment } from './environment.dev';

                  export const environment = devEnvironment;
                  EOF

            - name: Enable pgvector extension
              if: github.event.pull_request.head.repo.fork == false
              run: |
                  source .env
                  docker exec -e PGPASSWORD="$API_PG_DB_PASSWORD" postgres \
                    psql -U "$API_PG_DB_USERNAME" -d "$API_PG_DB_DATABASE" \
                    -c "CREATE EXTENSION IF NOT EXISTS vector;"

            - name: Run migrations
              if: github.event.pull_request.head.repo.fork == false
              run: yarn migration:run

            - name: Run tests
              run: API_NODE_ENV=test yarn test

            - name: Docker Compose Action Cleanup
              uses: hoverkraft-tech/compose-action@v2.0.1
              with:
                  compose-file: ./docker-compose.test.yml
                  down-flags: "-v"

            - name: Comment on PR if tests fail
              if: failure() && github.event.pull_request.head.repo.full_name == github.repository
              uses: actions/github-script@v7.0.1
              with:
                  github-token: ${{ github.token }}
                  script: |
                      const issue_number = context.payload.pull_request.number;
                      const user = context.payload.pull_request.user.login;
                      const message = `@${user}, failing tests`;
                      github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue_number,
                        body: message,
                      });

            - name: Notify Discord on Deploy Failure
              if: failure() && github.event.pull_request.head.repo.full_name == github.repository && env.DISCORD_WEBHOOK != ''
              uses: sarisia/actions-status-discord@v1.13.0
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
              with:
                  webhook: ${{ env.DISCORD_WEBHOOK }}
                  status: ${{ job.status }}
                  content: "‚ùå failing tests for PR: ${{ github.event.pull_request.title }} Author: @${{ github.event.pull_request.user.login }}"
                  username: GitHub Actions
