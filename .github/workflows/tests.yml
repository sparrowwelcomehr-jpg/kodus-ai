name: Run Tests

on:
    pull_request:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4.1.7

            - name: Set up environment variables
              run: cp .env.example .env

            - name: Create network
              run: docker network create kodus-backend-services-test || true

            - name: Docker Compose Action UP
              uses: hoverkraft-tech/compose-action@v2.0.1
              with:
                  compose-file: ./docker-compose.test.yml
                  up-flags: "-d"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      .yarn/cache
                      **/node_modules
                  key: ${{ runner.os }}-node22-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-node22-yarn-

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run migrations
              run: yarn migration:run

            - name: Run tests
              run: API_NODE_ENV=test yarn test

            - name: Docker Compose Action Cleanup
              uses: hoverkraft-tech/compose-action@v2.0.1
              with:
                  compose-file: ./docker-compose.test.yml
                  down-flags: "-v"

            - name: Comment on PR if tests fail
              if: failure() && github.event.pull_request.head.repo.full_name == github.repository
              uses: actions/github-script@v7.0.1
              with:
                  github-token: ${{ github.token }}
                  script: |
                      const issue_number = context.payload.pull_request.number;
                      const user = context.payload.pull_request.user.login;
                      const message = `@${user}, failing tests`;
                      github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue_number,
                        body: message,
                      });

            - name: Notify Discord on Deploy Failure
              if: failure() && github.event.pull_request.head.repo.full_name == github.repository && env.DISCORD_WEBHOOK != ''
              uses: sarisia/actions-status-discord@v1.13.0
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
              with:
                  webhook: ${{ env.DISCORD_WEBHOOK }}
                  status: ${{ job.status }}
                  content: "‚ùå failing tests for PR: ${{ github.event.pull_request.title }} Author: @${{ github.event.pull_request.user.login }}"
                  username: GitHub Actions
