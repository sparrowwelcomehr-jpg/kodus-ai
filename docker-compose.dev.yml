x-app-service-template: &app-service-defaults
    build:
        context: .
        dockerfile: docker/Dockerfile.dev
        args:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
    env_file:
        - ${ENV_FILE:-.env}
    environment:
        - CHOKIDAR_USEPOLLING=false
        - API_DEVELOPMENT_MODE=${API_DEVELOPMENT_MODE:-true}
    restart: unless-stopped
    volumes:
        - .:/usr/src/app:delegated
        - node_modules_cache:/usr/src/app/node_modules
        - yalc_store:/root/.yalc
    networks:
        - kodus-backend-services
        - shared-network

services:
    #----------------------------------------------------------------
    # Application Services
    #----------------------------------------------------------------
    api:
        <<: *app-service-defaults
        container_name: kodus_api
        ports:
            - '${API_PORT:-3001}:${API_PORT:-3001}'
            - '9229:9229'
            - '8000:8000'
        command: yarn start:dev:api
        deploy:
            resources:
                limits:
                    memory: 1.5G
                reservations:
                    memory: 512M
        healthcheck:
            test: ['CMD', 'node', '-e', 'process.exit(0)']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        environment:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
            - NODE_OPTIONS=--max-old-space-size=1200 --max-semi-space-size=64
            - DEBUG_PORT=9229
            - API_LOG_PRETTY=true
            - CHOKIDAR_USEPOLLING=false
            - API_DEVELOPMENT_MODE=${API_DEVELOPMENT_MODE:-true}
            - RUN_MIGRATIONS=true
            - RUN_SEEDS=true
            - PYROSCOPE_SERVER_ADDRESS=${PYROSCOPE_SERVER_ADDRESS:-http://pyroscope:4040}
            - PYROSCOPE_HEAP_PROFILING=${PYROSCOPE_HEAP_PROFILING:-true}

    worker:
        <<: *app-service-defaults
        container_name: kodus_worker
        ports:
            - '9231:9231'
            - '8001:8001'
        command: yarn start:dev:worker
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 512M
        healthcheck:
            test: ['CMD', 'node', '-e', 'process.exit(0)']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        environment:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
            - NODE_OPTIONS=--max-semi-space-size=64
            - DEBUG_PORT=9231
            - COMPONENT_TYPE=worker
            - API_LOG_PRETTY=true
            - PYROSCOPE_SERVER_ADDRESS=${PYROSCOPE_SERVER_ADDRESS:-http://pyroscope:4040}
            - PYROSCOPE_HEAP_PROFILING=${PYROSCOPE_HEAP_PROFILING:-true}

    webhooks:
        <<: *app-service-defaults
        container_name: kodus_webhooks
        ports:
            - '${API_WEBHOOKS_PORT:-3332}:${API_WEBHOOKS_PORT:-3332}'
            - '9232:9232'
            - '8002:8002'
        command: yarn start:dev:webhooks
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 256M
        healthcheck:
            test: ['CMD', 'node', '-e', 'process.exit(0)']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        environment:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
            - NODE_OPTIONS=--max-semi-space-size=64
            - DEBUG_PORT=9232
            - API_LOG_PRETTY=true
            - PYROSCOPE_SERVER_ADDRESS=${PYROSCOPE_SERVER_ADDRESS:-http://pyroscope:4040}
            - PYROSCOPE_HEAP_PROFILING=${PYROSCOPE_HEAP_PROFILING:-true}

    #----------------------------------------------------------------
    # Observability & Profiling
    #----------------------------------------------------------------
    pyroscope:
        profiles:
            - profiling
            - infra
        image: grafana/pyroscope:latest
        container_name: pyroscope
        ports:
            - '4040:4040'
        volumes:
            - pyroscope-data:/var/lib/pyroscope
        networks:
            - kodus-backend-services
        restart: unless-stopped

    #----------------------------------------------------------------
    # Databases & Infrastructure
    #----------------------------------------------------------------
    db_postgres:
        profiles:
            - local-db
            - infra
        image: pgvector/pgvector:pg16
        container_name: db_postgres
        ports:
            - '5432:5432'
        environment:
            POSTGRES_USER: ${API_PG_DB_USERNAME}
            POSTGRES_PASSWORD: ${API_PG_DB_PASSWORD}
            POSTGRES_DB: ${API_PG_DB_DATABASE}
        volumes:
            - pgdata:/var/lib/postgresql/data
            - ./docker/postgres/initdb.d:/docker-entrypoint-initdb.d
        networks:
            - kodus-backend-services
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'pg_isready -U ${API_PG_DB_USERNAME} -d ${API_PG_DB_DATABASE}',
                ]
            interval: 5s
            timeout: 3s
            retries: 20
            start_period: 10s

    db_mongodb:
        profiles:
            - local-db
            - infra
        image: mongo:8
        container_name: mongodb
        ports:
            - '27017:27017'
        volumes:
            - mongodbdata:/data/db
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${API_MG_DB_USERNAME}
            MONGO_INITDB_ROOT_PASSWORD: ${API_MG_DB_PASSWORD}
            MONGO_INITDB_DATABASE: ${API_MG_DB_DATABASE}
        networks:
            - kodus-backend-services
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    "echo 'db.runCommand({ ping: 1 }).ok' | mongosh --quiet mongodb://$${MONGO_INITDB_ROOT_USERNAME}:$${MONGO_INITDB_ROOT_PASSWORD}@localhost:27017/admin | grep -q 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 20
            start_period: 20s

volumes:
    yalc_store:
    node_modules_cache:
    pgdata:
    mongodbdata:
    pyroscope-data:

networks:
    kodus-backend-services:
        driver: bridge
        name: kodus-backend-services
        external: true
    shared-network:
        external: true
